# Local Development

## Pre-requisites:

-  Install the tools listed at the Makefile:
```sh
make prepare
```

- Every time there is a change on the swagger docs run:
 ```sh
make swag
```

## Commands for development

- To run the server in refresh mode use air:
 ```sh
make run
```

## App Structure

The main entrypoint for the app lives in `cmd/app/main.go`. This is where we declare and instantiate the required clients and interfaces for our service.

These clients and interfaces live in `internal/`

```go
|- cmd/                          // app entrypoints
|- api/                          // http server API
|- bootstrap/                    // configurations and initialization
|- domain/                       // domain models
|- docs/                         // swagger documentation
|- internal
    |- db                        // interfaces and clients for external services
    |- tokenutil/                // general utilities fot JWT
|- mocks/ .                      // mocks, largely generated by mockery
|- tools/                        // misc helper commands e.g. migration runner

(WIP)
|- internal
    |- adapters/postgres         // interfaces and clients for external services
    |- app/                      // app business logic
    |- models/                   // domain models
    |- transport/grpc            // handlers for our service
    |- health/                    
    |- metrics/                  
    |- middleware(grpc)/                  
    |- server(grpc)/                  
```

## Building from main

go build -gcflags="all=-N -l" -o tmp/ ./cmd/server

## Testing

```sh
make test

## For the GRPc server (WIP)
# Invoking the GRPC API using GRPCurl:
grpcurl -plaintext -d '{"anonymous_id":"test"}' localhost:8080 comics.API/QueryProviderUser

# (Note: Since there are no users in the database, `ERROR: Code: NotFound` is the expected response.)
```

### Mocks

[Mockery](https://github.com/vektra/mockery) is the tool used in the project
to generate mocks for packages and use them in tests.

To install mockery:
```sh
brew install mockery
```

Generally, mocks are added as needed, and all mocks should go in the `/mocks` directory. 
Mocks should be updated when functions are added/removed. 
For example mockery CLI usage to generate mocks:
```sh
mockery --keeptree --case underscore --with-expecter --dir ./internal/adapters --output ./mocks/adapters --all
mockery --keeptree --case underscore --with-expecter --dir ./internal/adapters/insights --output ./mocks/insights --name=IRepo
``